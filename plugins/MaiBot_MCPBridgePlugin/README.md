# MCP æ¡¥æ¥æ’ä»¶

å°† [MCP (Model Context Protocol)](https://modelcontextprotocol.io/) æœåŠ¡å™¨çš„å·¥å…·æ¡¥æ¥åˆ° MaiBotï¼Œä½¿å°ç†™èƒ½å¤Ÿè°ƒç”¨å¤–éƒ¨ MCP å·¥å…·ã€‚

<img width="3012" height="1794" alt="image" src="https://github.com/user-attachments/assets/ece56404-301a-4abf-b16d-87bd430fc977" />

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…

```bash
# å…‹éš†åˆ° MaiBot æ’ä»¶ç›®å½•
cd /path/to/MaiBot/plugins
git clone https://github.com/CharTyr/MaiBot_MCPBridgePlugin.git MCPBridgePlugin

# å®‰è£…ä¾èµ–
pip install mcp

# å¤åˆ¶é…ç½®æ–‡ä»¶
cd MCPBridgePlugin
cp config.example.toml config.toml
```

### 2. æ·»åŠ æœåŠ¡å™¨

ç¼–è¾‘ `config.toml`ï¼Œåœ¨ `[servers]` çš„ `claude_config_json` ä¸­å¡«å†™ Claude Desktop çš„ `mcpServers` JSONï¼š

```toml
[servers]
claude_config_json = '''
{
  "mcpServers": {
    "time": { "transport": "streamable_http", "url": "https://mcp.api-inference.modelscope.cn/server/mcp-server-time" },
    "my-server": { "transport": "streamable_http", "url": "https://mcp.xxx.com/mcp", "headers": { "Authorization": "Bearer ä½ çš„å¯†é’¥" } },
    "fetch": { "command": "uvx", "args": ["mcp-server-fetch"] }
  }
}
'''
```

### 3. å¯åŠ¨

é‡å¯ MaiBotï¼Œæˆ–å‘é€ `/mcp reconnect`

---

## ğŸ“š å»å“ªæ‰¾ MCP æœåŠ¡å™¨ï¼Ÿ

| å¹³å° | è¯´æ˜ |
|------|------|
| [mcp.modelscope.cn](https://mcp.modelscope.cn/) | é­”æ­ ModelScopeï¼Œå…è´¹æ¨è |
| [smithery.ai](https://smithery.ai/) | MCP æœåŠ¡å™¨æ³¨å†Œä¸­å¿ƒ |
| [github.com/modelcontextprotocol/servers](https://github.com/modelcontextprotocol/servers) | å®˜æ–¹æœåŠ¡å™¨åˆ—è¡¨ |

---

## ğŸ’¡ å¸¸ç”¨å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `/mcp` | æŸ¥çœ‹è¿æ¥çŠ¶æ€ |
| `/mcp tools` | æŸ¥çœ‹å¯ç”¨å·¥å…· |
| `/mcp reconnect` | é‡è¿æœåŠ¡å™¨ |
| `/mcp trace` | æŸ¥çœ‹è°ƒç”¨è®°å½• |
| `/mcp cache` | æŸ¥çœ‹ç¼“å­˜çŠ¶æ€ |
| `/mcp perm` | æŸ¥çœ‹æƒé™é…ç½® |
| `/mcp import <json>` | ğŸ†• å¯¼å…¥ Claude Desktop é…ç½® |
| `/mcp export` | ğŸ†• å¯¼å‡ºé…ç½® |
| `/mcp search <å…³é”®è¯>` | ğŸ†• æœç´¢å·¥å…· |
| `/mcp chain` | ğŸ†• æŸ¥çœ‹å·¥å…·é“¾ |
| `/mcp chain <åç§°>` | ğŸ†• æŸ¥çœ‹å·¥å…·é“¾è¯¦æƒ… |
| `/mcp chain test <åç§°> <å‚æ•°>` | ğŸ†• æµ‹è¯•æ‰§è¡Œå·¥å…·é“¾ |

---

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- ğŸ”Œ å¤šæœåŠ¡å™¨åŒæ—¶è¿æ¥
- ğŸ“¡ æ”¯æŒ stdio / SSE / HTTP / Streamable HTTP
- ğŸ”„ è‡ªåŠ¨é‡è¯•ã€å¿ƒè·³æ£€æµ‹ã€æ–­çº¿é‡è¿
- ğŸ–¥ï¸ WebUI å®Œæ•´é…ç½®æ”¯æŒ

### åŒè½¨åˆ¶æ¶æ„
- ğŸ”„ **ReActï¼ˆè½¯æµç¨‹ï¼‰**ï¼šLLM è‡ªä¸»å†³ç­–ï¼Œå¤šè½®åŠ¨æ€è°ƒç”¨ MCP å·¥å…·ï¼ˆé€‚åˆæ¢ç´¢å¼åœºæ™¯ï¼‰
- ğŸ”— **Workflowï¼ˆç¡¬æµç¨‹/å·¥å…·é“¾ï¼‰**ï¼šç”¨æˆ·é¢„å®šä¹‰æ­¥éª¤é¡ºåºä¸å‚æ•°ä¼ é€’ï¼ˆé€‚åˆå¯æ§å¯å¤ç”¨åœºæ™¯ï¼‰

### é«˜çº§åŠŸèƒ½
- ğŸ“¦ Resources æ”¯æŒï¼ˆå®éªŒæ€§ï¼‰
- ğŸ“ Prompts æ”¯æŒï¼ˆå®éªŒæ€§ï¼‰
- ğŸ”„ ç»“æœåå¤„ç†ï¼ˆLLM æ‘˜è¦æç‚¼ï¼‰
- ğŸ” è°ƒç”¨è¿½è¸ª / ğŸ—„ï¸ è°ƒç”¨ç¼“å­˜ / ğŸ” æƒé™æ§åˆ¶ / ğŸš« å·¥å…·ç¦ç”¨

### æ›´æ–°æ—¥å¿—
- è§ `plugins/MaiBot_MCPBridgePlugin/CHANGELOG.md`

---

## âš™ï¸ é…ç½®è¯´æ˜

### æœåŠ¡å™¨é…ç½®

```json
{
  "mcpServers": {
    "server_name": {
      "transport": "streamable_http",
      "url": "https://..."
    }
  }
}
```

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `mcpServers.<name>` | æœåŠ¡å™¨åç§°ï¼ˆå”¯ä¸€ï¼‰ |
| `enabled` | æ˜¯å¦å¯ç”¨ï¼ˆå¯é€‰ï¼Œé»˜è®¤ trueï¼‰ |
| `transport` | `stdio` / `sse` / `http` / `streamable_http` |
| `url` | è¿œç¨‹æœåŠ¡å™¨åœ°å€ |
| `headers` | ğŸ†• é‰´æƒå¤´ï¼ˆå¦‚ `{"Authorization": "Bearer xxx"}`ï¼‰ |
| `command` / `args` | æœ¬åœ°æœåŠ¡å™¨å¯åŠ¨å‘½ä»¤ |

### æƒé™æ§åˆ¶

**å¿«æ·é…ç½®ï¼ˆæ¨èï¼‰ï¼š**
```toml
[permissions]
perm_enabled = true
quick_deny_groups = "123456789"      # ç¦ç”¨çš„ç¾¤å·
quick_allow_users = "111111111"      # ç®¡ç†å‘˜ç™½åå•
```

**é«˜çº§è§„åˆ™ï¼š**
```json
[{"tool": "mcp_*_delete_*", "denied": ["qq:123456:group"]}]
```

### å·¥å…·ç¦ç”¨

```toml
[tools]
disabled_tools = '''
mcp_filesystem_delete_file
mcp_filesystem_write_file
'''
```

### è°ƒç”¨ç¼“å­˜

```toml
[settings]
cache_enabled = true
cache_ttl = 300
cache_exclude_tools = "mcp_*_time_*"
```

---

## â“ å¸¸è§é—®é¢˜

**Q: å·¥å…·æ²¡æœ‰æ³¨å†Œï¼Ÿ**
- æ£€æŸ¥ `enabled = true`
- æ£€æŸ¥ MaiBot æ—¥å¿—é”™è¯¯ä¿¡æ¯
- ç¡®è®¤ `pip install mcp`

**Q: JSON æ ¼å¼æŠ¥é”™ï¼Ÿ**
- å¤šè¡Œ JSON ç”¨ `'''` ä¸‰å¼•å·åŒ…è£¹
- ä½¿ç”¨è‹±æ–‡åŒå¼•å· `"`

**Q: å¦‚ä½•æ‰‹åŠ¨é‡è¿ï¼Ÿ**
- `/mcp reconnect` æˆ– `/mcp reconnect æœåŠ¡å™¨å`

---

## ğŸ“¥ é…ç½®å¯¼å…¥å¯¼å‡ºï¼ˆClaude mcpServersï¼‰

### ä» Claude Desktop å¯¼å…¥

å¦‚æœä½ å·²æœ‰ Claude Desktop çš„ MCP é…ç½®ï¼Œå¯ä»¥ç›´æ¥å¯¼å…¥ï¼š

```
/mcp import {"mcpServers":{"time":{"command":"uvx","args":["mcp-server-time"]},"fetch":{"command":"uvx","args":["mcp-server-fetch"]}}}
```

æ”¯æŒçš„æ ¼å¼ï¼š
- Claude Desktop æ ¼å¼ï¼ˆ`mcpServers` å¯¹è±¡ï¼‰
- å…¼å®¹æ—§ç‰ˆï¼šMaiBot servers åˆ—è¡¨æ•°ç»„ï¼ˆå°†è‡ªåŠ¨è¿ç§»ä¸º `mcpServers`ï¼‰

### å¯¼å‡ºé…ç½®

```
/mcp export           # å¯¼å‡ºä¸º Claude Desktop æ ¼å¼ï¼ˆé»˜è®¤ï¼‰
/mcp export claude    # å¯¼å‡ºä¸º Claude Desktop æ ¼å¼
```

### æ³¨æ„äº‹é¡¹
- å¯¼å…¥æ—¶ä¼šè‡ªåŠ¨è·³è¿‡åŒåæœåŠ¡å™¨
- å¯¼å…¥åéœ€è¦å‘é€ `/mcp reconnect` ä½¿é…ç½®ç”Ÿæ•ˆ
- æ”¯æŒ stdioã€sseã€httpã€streamable_http å…¨éƒ¨ä¼ è¾“ç±»å‹

---

## ğŸ”— Workflowï¼ˆç¡¬æµç¨‹/å·¥å…·é“¾ï¼‰

å·¥å…·é“¾å…è®¸ä½ å°†å¤šä¸ª MCP å·¥å…·æŒ‰é¡ºåºæ‰§è¡Œï¼Œåç»­å·¥å…·å¯ä»¥ä½¿ç”¨å‰åºå·¥å…·çš„è¾“å‡ºä½œä¸ºè¾“å…¥ã€‚

### 1 åˆ†é’Ÿä¸Šæ‰‹ï¼ˆæ¨è WebUIï¼‰
1. å…ˆå®Œæˆ MCP æœåŠ¡å™¨é…ç½®å¹¶ `/mcp reconnect`
2. å‘é€ `/mcp tools`ï¼Œå¤åˆ¶ä½ è¦ç”¨çš„å·¥å…·å
3. æ‰“å¼€ WebUI â†’ ã€ŒWorkflowï¼ˆç¡¬æµç¨‹/å·¥å…·é“¾ï¼‰ã€â†’ ç”¨â€œå¿«é€Ÿæ·»åŠ â€è¡¨å•å¡«å…¥ï¼š
   - åç§°/æè¿°
   - è¾“å…¥å‚æ•°ï¼ˆæ¯è¡Œ `å‚æ•°å=æè¿°`ï¼‰
   - æ‰§è¡Œæ­¥éª¤ï¼ˆæ¯è¡Œ `å·¥å…·å|å‚æ•°JSON|è¾“å‡ºé”®`ï¼‰
4. åœ¨â€œç¡®è®¤æ·»åŠ â€ä¸­è¾“å…¥ `ADD` å¹¶ä¿å­˜

### å¿«é€Ÿæ·»åŠ å·¥å…·é“¾ï¼ˆæ¨èï¼‰

åœ¨ WebUI çš„ã€Œå·¥å…·é“¾ã€é…ç½®åŒºï¼Œä½¿ç”¨è¡¨å•å¿«é€Ÿæ·»åŠ ï¼š

1. **åç§°**: å¡«å†™å·¥å…·é“¾åç§°ï¼ˆè‹±æ–‡ï¼Œå¦‚ `search_and_detail`ï¼‰
2. **æè¿°**: å¡«å†™å·¥å…·é“¾ç”¨é€”ï¼ˆä¾› LLM ç†è§£ä½•æ—¶ä½¿ç”¨ï¼‰
3. **è¾“å…¥å‚æ•°**: æ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ `å‚æ•°å=æè¿°`
   ```
   query=æœç´¢å…³é”®è¯
   max_results=æœ€å¤§ç»“æœæ•°
   ```
4. **æ‰§è¡Œæ­¥éª¤**: æ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼ `å·¥å…·å|å‚æ•°JSON|è¾“å‡ºé”®`
   ```
   mcp_server_search|{"keyword":"${input.query}"}|search_result
   mcp_server_detail|{"id":"${prev}"}|
   ```
5. **ç¡®è®¤æ·»åŠ **: è¾“å…¥ `ADD` å¹¶ä¿å­˜

### JSON é…ç½®æ–¹å¼

ä¹Ÿå¯ä»¥ç›´æ¥åœ¨ã€Œå·¥å…·é“¾åˆ—è¡¨ã€ä¸­ç¼–å†™ JSONï¼š

```json
[
  {
    "name": "search_and_detail",
    "description": "å…ˆæœç´¢æ¨¡ç»„ï¼Œå†è·å–è¯¦æƒ…",
    "input_params": {
      "query": "æœç´¢å…³é”®è¯"
    },
    "steps": [
      {
        "tool_name": "mcp_mcmod_search_mod",
        "args_template": {"keyword": "${input.query}", "limit": 1},
        "output_key": "search_result",
        "description": "æœç´¢æ¨¡ç»„"
      },
      {
        "tool_name": "mcp_mcmod_get_mod_detail",
        "args_template": {"mod_id": "${prev}"},
        "description": "è·å–è¯¦æƒ…"
      }
    ]
  }
]
```

### å˜é‡æ›¿æ¢

| å˜é‡æ ¼å¼ | è¯´æ˜ |
|---------|------|
| `${input.å‚æ•°å}` | ç”¨æˆ·è¾“å…¥çš„å‚æ•° |
| `${step.è¾“å‡ºé”®}` | æŸä¸ªæ­¥éª¤çš„è¾“å‡ºï¼ˆé€šè¿‡ `output_key` æŒ‡å®šï¼‰ |
| `${prev}` | ä¸Šä¸€æ­¥çš„è¾“å‡º |
| `${prev.å­—æ®µ}` | ä¸Šä¸€æ­¥è¾“å‡ºï¼ˆJSONï¼‰çš„æŸä¸ªå­—æ®µ |
| `${step.geo.return.0.location}` | æ•°ç»„ä¸‹æ ‡è®¿é—®ï¼ˆdotï¼‰ |
| `${step.geo.return[0].location}` | æ•°ç»„ä¸‹æ ‡è®¿é—®ï¼ˆ[]ï¼‰ |
| `${step.geo['return'][0]['location']}` | bracket å†™æ³•ï¼ˆæœ€é€šç”¨ï¼‰ |

### å·¥å…·é“¾å­—æ®µè¯´æ˜

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `name` | å·¥å…·é“¾åç§°ï¼Œå°†ç”Ÿæˆ `chain_xxx` å·¥å…· |
| `description` | æè¿°ï¼Œä¾› LLM ç†è§£ä½•æ—¶ä½¿ç”¨ |
| `input_params` | è¾“å…¥å‚æ•°å®šä¹‰ `{å‚æ•°å: æè¿°}` |
| `steps` | æ‰§è¡Œæ­¥éª¤æ•°ç»„ |
| `steps[].tool_name` | è¦è°ƒç”¨çš„å·¥å…·å |
| `steps[].args_template` | å‚æ•°æ¨¡æ¿ï¼Œæ”¯æŒå˜é‡æ›¿æ¢ |
| `steps[].output_key` | è¾“å‡ºå­˜å‚¨é”®åï¼ˆå¯é€‰ï¼‰ |
| `steps[].optional` | æ˜¯å¦å¯é€‰ï¼Œå¤±è´¥æ—¶ç»§ç»­æ‰§è¡Œï¼ˆé»˜è®¤ falseï¼‰ |

### å‘½ä»¤

```bash
/mcp chain                    # æŸ¥çœ‹æ‰€æœ‰å·¥å…·é“¾
/mcp chain list               # åˆ—å‡ºå·¥å…·é“¾
/mcp chain <åç§°>             # æŸ¥çœ‹è¯¦æƒ…
/mcp chain test <åç§°> {"query": "JEI"}  # æµ‹è¯•æ‰§è¡Œ
/mcp chain reload             # é‡æ–°åŠ è½½é…ç½®
```

---

## ğŸ”„ åŒè½¨åˆ¶æ¶æ„

MCP æ¡¥æ¥æ’ä»¶æ”¯æŒä¸¤ç§å·¥å…·è°ƒç”¨æ¨¡å¼ï¼Œå¯æ ¹æ®åœºæ™¯é€‰æ‹©ï¼š

### ReAct è½¯æµç¨‹

LLM è‡ªä¸»å†³ç­–çš„å¤šè½®å·¥å…·è°ƒç”¨æ¨¡å¼ï¼Œé€‚åˆå¤æ‚ã€ä¸ç¡®å®šçš„åœºæ™¯ã€‚

**å·¥ä½œåŸç†ï¼š**
1. ç”¨æˆ·æé—® â†’ LLM åˆ†æéœ€è¦ä»€ä¹ˆä¿¡æ¯
2. LLM é€‰æ‹©è°ƒç”¨å·¥å…· â†’ è·å–ç»“æœ
3. LLM è§‚å¯Ÿç»“æœ â†’ å†³å®šæ˜¯å¦éœ€è¦æ›´å¤šä¿¡æ¯
4. é‡å¤ 2-3 ç›´åˆ°ä¿¡æ¯è¶³å¤Ÿ â†’ ç”Ÿæˆæœ€ç»ˆå›ç­”

**å¯ç”¨æ–¹å¼ï¼š**
åœ¨ WebUIã€ŒReAct (è½¯æµç¨‹)ã€é…ç½®åŒºå¯ç”¨ï¼ŒMCP å·¥å…·å°†è‡ªåŠ¨æ³¨å†Œåˆ° MaiBot çš„è®°å¿†æ£€ç´¢ ReAct ç³»ç»Ÿã€‚

**é€‚ç”¨åœºæ™¯ï¼š**
- å¤æ‚é—®é¢˜éœ€è¦å¤šæ­¥æ¨ç†
- ä¸ç¡®å®šéœ€è¦è°ƒç”¨å“ªäº›å·¥å…·
- éœ€è¦æ ¹æ®ä¸­é—´ç»“æœåŠ¨æ€è°ƒæ•´

### Workflow ç¡¬æµç¨‹

ç”¨æˆ·é¢„å®šä¹‰çš„å·¥ä½œæµï¼Œå›ºå®šæ‰§è¡Œé¡ºåºï¼Œé€‚åˆå¯é ã€å¯æ§çš„åœºæ™¯ã€‚

**å·¥ä½œåŸç†ï¼š**
1. ç”¨æˆ·å®šä¹‰æ­¥éª¤é¡ºåºå’Œå‚æ•°ä¼ é€’
2. æŒ‰é¡ºåºæ‰§è¡Œæ¯ä¸ªæ­¥éª¤
3. åç»­æ­¥éª¤å¯ä½¿ç”¨å‰åºæ­¥éª¤çš„è¾“å‡º
4. è¿”å›æœ€ç»ˆç»“æœ

**é€‚ç”¨åœºæ™¯ï¼š**
- æµç¨‹å›ºå®šã€å¯é¢„æµ‹
- éœ€è¦å¯é ã€å¯é‡å¤çš„æ‰§è¡Œ
- å¸Œæœ›ç²¾ç¡®æ§åˆ¶å·¥å…·è°ƒç”¨é¡ºåº

### å¯¹æ¯”

| ç‰¹æ€§ | ReAct è½¯æµç¨‹ | Workflow ç¡¬æµç¨‹ |
|------|-------------|----------------|
| å†³ç­–è€… | LLM è‡ªä¸»å†³ç­– | ç”¨æˆ·é¢„å®šä¹‰ |
| çµæ´»æ€§ | é«˜ï¼ŒåŠ¨æ€è°ƒæ•´ | ä½ï¼Œå›ºå®šæµç¨‹ |
| å¯é¢„æµ‹æ€§ | ä½ | é«˜ |
| é€‚ç”¨åœºæ™¯ | å¤æ‚ã€æ¢ç´¢æ€§ä»»åŠ¡ | å›ºå®šã€é‡å¤æ€§ä»»åŠ¡ |
| é…ç½®æ–¹å¼ | å¯ç”¨å³å¯ | éœ€è¦å®šä¹‰æ­¥éª¤ |

---

## ğŸ“‹ ä¾èµ–

- MaiBot >= 0.11.6
- Python >= 3.10
- mcp >= 1.0.0

## ğŸ“„ è®¸å¯è¯

AGPL-3.0
